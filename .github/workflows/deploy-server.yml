name: 'CD - Deploy Server to Oracle Cloud'

# Deploy only when server code changes and tests pass
on:
  push:
    branches: [main]
    paths:
      - 'server/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: 'Deploy to Oracle Cloud (Production)'
    runs-on: ubuntu-latest
    # Only deploy if tests passed (runs after test.yml)
    needs: []  # Will be auto-skipped if test.yml fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Oracle Cloud via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script_stop: true  # Stop on first error
          script: |
            set -e  # Exit on error

            echo "üöÄ Starting deployment..."

            # Check if repository exists, if not clone it
            if [ ! -d "/home/ubuntu/TimeTracking-Clean" ]; then
              echo "üì• Repository not found. Cloning..."
              cd /home/ubuntu
              git clone https://github.com/Maxwellbadger-1/TimeTracking-Clean.git
            fi

            cd /home/ubuntu/TimeTracking-Clean

            # Backup current database (safety!)
            echo "üíæ Creating database backup..."
            cp server/database.db server/database.backup.$(date +%Y%m%d_%H%M%S).db || true

            # Pull latest code
            echo "üì• Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            # Clean up old files
            echo "üßπ Cleaning up old files..."
            find server -name "*.mjs" -delete 2>/dev/null || true

            # Install dependencies and build
            echo "üì¶ Installing dependencies..."
            cd server
            npm install  # Using npm install (project doesn't have package-lock.json)

            echo "üî® Building TypeScript..."
            npm run build

            # Check if build succeeded
            if [ ! -f "dist/server.js" ]; then
              echo "‚ùå Build failed! dist/server.js not found"
              exit 1
            fi

            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            NODE_ENV=production npm run migrate:prod || {
              echo "‚ùå Migration failed! Deployment aborted."
              echo "üí° Database backup available: server/database.backup.*.db"
              exit 1
            }
            echo "‚úÖ Migrations completed successfully"

            # Validate database schema (non-blocking)
            echo "üîç Validating database schema..."
            NODE_ENV=production npm run validate:schema || true
            echo "‚úÖ Schema validation completed"

            # Fix overtime calculations (ensure all months exist)
            echo "üìä Fixing overtime calculations..."
            NODE_ENV=production npx tsx scripts/fix-overtime.ts || {
              echo "‚ö†Ô∏è  Overtime fix had issues, but continuing deployment..."
            }
            echo "‚úÖ Overtime calculations updated"

            # Setup automatic daily cron job (runs at 3 AM every day)
            echo "‚è∞ Setting up automatic daily overtime recalculation..."
            CRON_COMMAND="0 3 * * * cd /home/ubuntu/TimeTracking-Clean/server && NODE_ENV=production npx tsx scripts/fix-overtime.ts >> /home/ubuntu/logs/overtime-fix.log 2>&1"
            mkdir -p /home/ubuntu/logs
            (crontab -l 2>/dev/null | grep -v "fix-overtime.ts"; echo "$CRON_COMMAND") | crontab - || {
              echo "‚ö†Ô∏è  Cron setup failed, continuing without automatic recalculation..."
            }
            echo "‚úÖ Cron job setup attempted"

            # Create .env file if it doesn't exist
            echo "üîê Setting up environment..."
            if [ ! -f ".env" ]; then
              echo "Creating .env file..."
              SESSION_SECRET=$(openssl rand -hex 32)
              echo "SESSION_SECRET=$SESSION_SECRET" > .env
              echo "NODE_ENV=production" >> .env
              echo "TZ=Europe/Berlin" >> .env
              echo "PORT=3000" >> .env
            else
              # More robust extraction of SESSION_SECRET (handles spaces, quotes, etc.)
              SESSION_SECRET=$(grep "^SESSION_SECRET=" .env | cut -d= -f2- | tr -d '"' | tr -d "'" | xargs)
            fi

            if [ -z "$SESSION_SECRET" ]; then
              echo "‚ùå SESSION_SECRET could not be set!"
              echo "Generating new SESSION_SECRET..."
              SESSION_SECRET=$(openssl rand -hex 32)
              # Update or append to .env
              if grep -q "^SESSION_SECRET=" .env 2>/dev/null; then
                sed -i "s/^SESSION_SECRET=.*/SESSION_SECRET=$SESSION_SECRET/" .env
              else
                echo "SESSION_SECRET=$SESSION_SECRET" >> .env
              fi
            fi

            echo "‚úÖ Environment setup completed successfully"

            # Restart PM2
            echo "üîÑ Restarting PM2..."
            pm2 stop timetracking-server || true
            pm2 delete timetracking-server || true

            # Set ALLOWED_ORIGINS for CORS
            export ALLOWED_ORIGINS='tauri://localhost,https://tauri.localhost,http://tauri.localhost,http://localhost:1420'

            TZ=Europe/Berlin NODE_ENV=production SESSION_SECRET=$SESSION_SECRET ALLOWED_ORIGINS=$ALLOWED_ORIGINS \
              pm2 start dist/server.js \
              --name timetracking-server \
              --cwd /home/ubuntu/TimeTracking-Clean/server \
              --time \
              --update-env
            pm2 save

            # Wait for server to start
            echo "‚è≥ Waiting for server to start..."
            sleep 5

            # Health check
            echo "üè• Running health check..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Deployment successful! Server is healthy"
              pm2 status
            else
              echo "‚ùå Health check failed! HTTP $HTTP_CODE"
              pm2 logs timetracking-server --lines 50
              exit 1
            fi

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment to Oracle Cloud successful!"
          echo "üåê Server URL: http://129.159.8.19:3000"
          echo "üìä Check status: ssh ubuntu@129.159.8.19 'pm2 status'"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs: ssh ubuntu@129.159.8.19 'pm2 logs timetracking-server --lines 100'"
