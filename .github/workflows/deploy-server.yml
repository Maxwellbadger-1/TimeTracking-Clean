name: 'CD - Deploy Server to Oracle Cloud'

# Deploy only when server code changes and tests pass
on:
  push:
    branches: [main]
    paths:
      - 'server/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: 'Deploy to Oracle Cloud (Production)'
    runs-on: ubuntu-latest
    # Only deploy if tests passed (runs after test.yml)
    needs: []  # Will be auto-skipped if test.yml fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Oracle Cloud via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script_stop: true  # Stop on first error
          script: |
            set -e  # Exit on error

            echo "ðŸš€ Starting deployment..."

            # Check if repository exists, if not clone it
            if [ ! -d "/home/ubuntu/TimeTracking-Clean" ]; then
              echo "ðŸ“¥ Repository not found. Cloning..."
              cd /home/ubuntu
              git clone https://github.com/Maxwellbadger-1/TimeTracking-Clean.git
            fi

            cd /home/ubuntu/TimeTracking-Clean

            # Backup current database (safety!)
            echo "ðŸ’¾ Creating database backup..."
            cp server/database.db server/database.backup.$(date +%Y%m%d_%H%M%S).db || true

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            # Clean up old files
            echo "ðŸ§¹ Cleaning up old files..."
            find server -name "*.mjs" -delete 2>/dev/null || true

            # Install dependencies and build
            echo "ðŸ“¦ Installing dependencies..."
            cd server
            npm install  # Using npm install (project doesn't have package-lock.json)

            echo "ðŸ”¨ Building TypeScript..."
            npm run build

            # Check if build succeeded
            if [ ! -f "dist/server.js" ]; then
              echo "âŒ Build failed! dist/server.js not found"
              exit 1
            fi

            # Run database migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            NODE_ENV=production npm run migrate:prod || {
              echo "âŒ Migration failed! Deployment aborted."
              echo "ðŸ’¡ Database backup available: server/database.backup.*.db"
              exit 1
            }
            echo "âœ… Migrations completed successfully"

            # Fix overtime calculations (ensure all months exist)
            echo "ðŸ“Š Fixing overtime calculations..."
            npx tsx scripts/fix-overtime.ts || {
              echo "âš ï¸  Overtime fix had issues, but continuing deployment..."
            }
            echo "âœ… Overtime calculations updated"

            # Setup automatic daily cron job (runs at 3 AM every day)
            echo "â° Setting up automatic daily overtime recalculation..."
            CRON_COMMAND="0 3 * * * cd /home/ubuntu/TimeTracking-Clean/server && npx tsx scripts/fix-overtime.ts >> /home/ubuntu/logs/overtime-fix.log 2>&1"
            mkdir -p /home/ubuntu/logs
            (crontab -l 2>/dev/null | grep -v "fix-overtime.ts"; echo "$CRON_COMMAND") | crontab -
            echo "âœ… Cron job configured (runs daily at 3 AM)"

            # Create .env file if it doesn't exist
            echo "ðŸ” Setting up environment..."
            if [ ! -f ".env" ]; then
              echo "Creating .env file..."
              SESSION_SECRET=$(openssl rand -hex 32)
              cat > .env << EOF
SESSION_SECRET=$SESSION_SECRET
NODE_ENV=production
TZ=Europe/Berlin
PORT=3000
EOF
            else
              SESSION_SECRET=$(grep SESSION_SECRET .env | cut -d= -f2)
            fi

            if [ -z "$SESSION_SECRET" ]; then
              echo "âŒ SESSION_SECRET could not be set!"
              exit 1
            fi

            # Restart PM2
            echo "ðŸ”„ Restarting PM2..."
            pm2 stop timetracking-server || true
            pm2 delete timetracking-server || true

            # Set ALLOWED_ORIGINS for CORS
            export ALLOWED_ORIGINS='tauri://localhost,https://tauri.localhost,http://tauri.localhost,http://localhost:1420'

            TZ=Europe/Berlin NODE_ENV=production SESSION_SECRET=$SESSION_SECRET ALLOWED_ORIGINS=$ALLOWED_ORIGINS \
              pm2 start dist/server.js \
              --name timetracking-server \
              --cwd /home/ubuntu/TimeTracking-Clean/server \
              --time \
              --update-env
            pm2 save

            # Wait for server to start
            echo "â³ Waiting for server to start..."
            sleep 5

            # Health check
            echo "ðŸ¥ Running health check..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Deployment successful! Server is healthy"
              pm2 status
            else
              echo "âŒ Health check failed! HTTP $HTTP_CODE"
              pm2 logs timetracking-server --lines 50
              exit 1
            fi

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deployment to Oracle Cloud successful!"
          echo "ðŸŒ Server URL: http://129.159.8.19:3000"
          echo "ðŸ“Š Check status: ssh ubuntu@129.159.8.19 'pm2 status'"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs: ssh ubuntu@129.159.8.19 'pm2 logs timetracking-server --lines 100'"
